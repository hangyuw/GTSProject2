{
	"name": "dataflow1",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "business_json",
						"type": "DatasetReference"
					},
					"name": "source1"
				},
				{
					"dataset": {
						"referenceName": "checkin_json",
						"type": "DatasetReference"
					},
					"name": "source2"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "Json1",
						"type": "DatasetReference"
					},
					"name": "sink1",
					"rejectedDataLinkedService": {
						"referenceName": "AzureBlobStorage1",
						"type": "LinkedServiceReference"
					}
				},
				{
					"dataset": {
						"referenceName": "output_2",
						"type": "DatasetReference"
					},
					"name": "sink2"
				}
			],
			"transformations": [
				{
					"name": "aggregate1"
				},
				{
					"name": "select1"
				},
				{
					"name": "flattenAttributes"
				},
				{
					"name": "select2"
				},
				{
					"name": "join1"
				},
				{
					"name": "aggregate2"
				},
				{
					"name": "flatten1"
				}
			],
			"scriptLines": [
				"source(output(",
				"          business_id as string,",
				"          name as string,",
				"          address as string,",
				"          city as string,",
				"          state as string,",
				"          postal_code as string,",
				"          latitude as double,",
				"          longitude as double,",
				"          stars as double,",
				"          review_count as integer,",
				"          is_open as integer,",
				"          attributes as (ByAppointmentOnly as string, BusinessAcceptsCreditCards as string, BikeParking as string, RestaurantsPriceRange2 as string, CoatCheck as string, RestaurantsTakeOut as string, RestaurantsDelivery as string, Caters as string, WiFi as string, BusinessParking as string, WheelchairAccessible as string, HappyHour as string, OutdoorSeating as string, HasTV as string, RestaurantsReservations as string, DogsAllowed as string, Alcohol as string, GoodForKids as string, RestaurantsAttire as string, Ambience as string, RestaurantsTableService as string, RestaurantsGoodForGroups as string, DriveThru as string, NoiseLevel as string),",
				"          categories as string,",
				"          hours as (Monday as string, Tuesday as string, Wednesday as string, Thursday as string, Friday as string, Saturday as string, Sunday as string)",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     documentForm: 'documentPerLine') ~> source1",
				"source(output(",
				"          business_id as string,",
				"          date as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     ignoreNoFilesFound: false,",
				"     documentForm: 'documentPerLine') ~> source2",
				"source1 aggregate(groupBy(business_id),",
				"     attributes = collect(attributes),",
				"          hours = collect(hours)) ~> aggregate1",
				"source1 select(mapColumn(",
				"          business_id,",
				"          name,",
				"          address,",
				"          city,",
				"          state,",
				"          postal_code,",
				"          latitude,",
				"          longitude,",
				"          stars,",
				"          review_count,",
				"          is_open,",
				"          categories",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> select1",
				"aggregate1 foldDown(unrollMultiple(attributes,hours),",
				"     mapColumn(",
				"          attributes,",
				"          hours,",
				"          business_id",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> flattenAttributes",
				"flattenAttributes select(mapColumn(",
				"          business_id,",
				"          BikeParking = attributes.BikeParking,",
				"          RestaurantsPriceRange2 = attributes.RestaurantsPriceRange2,",
				"          CoatCheck = attributes.CoatCheck,",
				"          RestaurantsTakeOut = attributes.RestaurantsTakeOut,",
				"          RestaurantsDelivery = attributes.RestaurantsDelivery,",
				"          Caters = attributes.Caters,",
				"          WiFi = attributes.WiFi,",
				"          WheelchairAccessible = attributes.WheelchairAccessible,",
				"          HappyHour = attributes.HappyHour,",
				"          OutdoorSeating = attributes.OutdoorSeating,",
				"          BusinessAcceptsCreditCards = attributes.BusinessAcceptsCreditCards,",
				"          ByAppointmentOnly = attributes.ByAppointmentOnly,",
				"          HasTV = attributes.HasTV,",
				"          RestaurantsReservations = attributes.RestaurantsReservations,",
				"          GoodForKids = attributes.GoodForKids,",
				"          RestaurantsGoodForGroups = attributes.RestaurantsGoodForGroups,",
				"          hours = hours.Monday,",
				"          Tuesday = hours.Tuesday,",
				"          Wednesday = hours.Wednesday,",
				"          Thursday = hours.Thursday,",
				"          Friday = hours.Friday,",
				"          Saturday = hours.Saturday,",
				"          Sunday = hours.Sunday",
				"     ),",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true) ~> select2",
				"select2, select1 join(select2@business_id == select1@business_id,",
				"     joinType:'outer',",
				"     matchType:'exact',",
				"     ignoreSpaces: false,",
				"     broadcast: 'auto')~> join1",
				"source2 aggregate(business_id = collect(business_id),",
				"          date = collect(date)) ~> aggregate2",
				"aggregate2 foldDown(unrollMultiple(business_id,date),",
				"     mapColumn(",
				"          business_id,",
				"          date",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> flatten1",
				"join1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:['output_business_json'],",
				"     truncate: true,",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     saveOrder: 1,",
				"     partitionBy('hash', 1)) ~> sink1",
				"flatten1 sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     partitionFileNames:['output_secound'],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     partitionBy('hash', 1)) ~> sink2"
			]
		}
	}
}